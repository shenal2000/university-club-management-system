<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/a2d9b7f5c3.js" crossorigin="anonymous"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        *{box-sizing:border-box;margin:0;padding:0;}
        body{font-family:'Inter',sans-serif;background:#f5f6fa;}
        .dashboard-container{display:flex;height:100vh;}

        /* Sidebar */
        .sidebar {
    width: 230px;
    background: #0f172a;
    color: #fff;
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.sidebar h2 {
    margin-bottom: 30px;
    font-weight: 700;
}

.sidebar a {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    color: #cbd5e1;
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.sidebar a:hover,
.sidebar a.active {
    background: #2563eb;
    color: #fff;
}

/* Push logout to bottom */
.logout-btn {
    margin-top: auto;
    background: #dc2626;
    color: white !important;
}

.logout-btn:hover {
    background: #b91c1c !important;
}


        /* Main content */
        .main-content{flex:1;padding:30px;overflow-y:auto;}
        h2{margin-bottom:20px;font-weight:600;color:#111827;}

        /* Cards */
        .cards{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:20px;
            margin-bottom:30px;
        }
        .card{
            background:#fff;
            padding:20px;
            border-radius:12px;
            box-shadow:0 6px 18px rgba(0,0,0,.06);
            transition:0.3s;
        }
        .card:hover{transform:translateY(-4px);}
        .card h3{color:#6b7280;font-size:15px;margin-bottom:6px;}
        .card p{font-size:28px;font-weight:700;color:#111827;}

        /* Charts */
        .charts{
            display:grid;
            grid-template-columns: repeat(auto-fit,minmax(400px,1fr));
            gap:25px;
            margin-bottom:50px;
        }
        .chart-box{
            background:#fff;
            padding:25px;
            border-radius:12px;
            box-shadow:0 6px 18px rgba(0,0,0,.06);
        }
        .chart-box h3{
            margin-bottom:15px;
            font-weight:600;
            color:#111827;
        }
        canvas{max-width:100%;}
    </style>
</head>
<body>

<div class="dashboard-container">

    <div class="sidebar">
        <h2>Admin</h2>

        <a href="admindashboard.html">
            <i class="fa-solid fa-chart-pie"></i> Dashboard
        </a>

        <a href="adminclubdashboard.html">
            <i class="fa-solid fa-building"></i> Clubs
        </a>

        <a href="adminuserdashboard.html">
            <i class="fa-solid fa-user"></i> Users
        </a>

        <a href="admineventdashboard.html">
            <i class="fa-solid fa-calendar-days"></i> Events
        </a>

        <a href="adminannouncementdashboard.html">
            <i class="fa-solid fa-bullhorn"></i> Announcements
        </a>

        <a href="adminmemberdashboard.html">
            <i class="fa-solid fa-users"></i> Members
        </a>

        <!-- Logout -->
        <a href="#" class="logout-btn" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
        </a>
    </div>


    <!-- Main Content -->
    <div class="main-content">
        <h2>Overview</h2>

        <!-- Stat Cards -->
        <div class="cards">
            <div class="card"><h3>Total Clubs</h3><p id="totalClubs">0</p></div>
            <div class="card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
            <div class="card"><h3>Total Events</h3><p id="totalEvents">0</p></div>
            <div class="card"><h3>Total Announcements</h3><p id="totalAnnouncements">0</p></div>
        </div>

        <!-- Charts -->
        <div class="charts">
            <div class="chart-box">
                <h3>Users by Role</h3>
                <canvas id="userRoleChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Clubs by Category</h3>
                <canvas id="clubCategoryChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Members per Club</h3>
                <canvas id="clubMemberChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Events per Club</h3>
                <canvas id="clubEventChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Announcements per Club</h3>
                <canvas id="clubAnnouncementChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const BASE_URL = "http://localhost:8080";

    async function fetchJSON(endpoint){
        const res = await fetch(`${BASE_URL}/${endpoint}`);
        return await res.json();
    }

    // Generate colors for bars
    function generateColors(count){
        const colors=[];
        for(let i=0;i<count;i++){
            const r=Math.floor(Math.random()*200)+30;
            const g=Math.floor(Math.random()*200)+30;
            const b=Math.floor(Math.random()*200)+30;
            colors.push(`rgba(${r},${g},${b},0.7)`);
        }
        return colors;
    }

    async function loadDashboard(){
        try{
            const users = await fetchJSON("users");
            const clubs = await fetchJSON("clubs");

            // Events and Announcements per club
            const clubEvents = {};
            const clubAnnouncements = {};
            const clubMembers = {};

            for(const club of clubs){
                const members = await fetchJSON(`club-members/club/${club.clubId}`);
                const events = await fetchJSON(`api/events/club/${club.clubId}`);
                const announcements = await fetchJSON(`api/announcements/club/${club.clubId}`);

                clubMembers[club.clubName] = members.length;
                clubEvents[club.clubName] = events.length;
                clubAnnouncements[club.clubName] = announcements.length;
            }

            // Totals
            const totalEvents = Object.values(clubEvents).reduce((a,b)=>a+b,0);
            const totalAnnouncements = Object.values(clubAnnouncements).reduce((a,b)=>a+b,0);

            document.getElementById("totalUsers").innerText = users.length;
            document.getElementById("totalClubs").innerText = clubs.length;
            document.getElementById("totalEvents").innerText = totalEvents;
            document.getElementById("totalAnnouncements").innerText = totalAnnouncements;

            // Users by Role Pie
            const roles = users.reduce((acc,u)=>{
                acc[u.roleGlobal] = (acc[u.roleGlobal]||0)+1;
                return acc;
            },{});
            new Chart(document.getElementById("userRoleChart"),{
                type:'pie',
                data:{ labels:Object.keys(roles), datasets:[{data:Object.values(roles), backgroundColor:["#2563eb","#22c55e","#f59e0b","#8b5cf6"]}] }
            });

            // Clubs by Category
            const categories = clubs.reduce((acc,c)=>{
                acc[c.clubCategory] = (acc[c.clubCategory]||0)+1;
                return acc;
            },{});
            new Chart(document.getElementById("clubCategoryChart"),{
                type:'bar',
                data:{ labels:Object.keys(categories), datasets:[{label:'Clubs', data:Object.values(categories), backgroundColor:["#2563eb","#ef4444","#22c55e","#f59e0b"]}] },
                options:{
                    responsive:true,
                    scales:{y:{beginAtZero:true, ticks:{precision:0}}}
                }
            });

            // Members per Club
            new Chart(document.getElementById("clubMemberChart"),{
                type:'bar',
                data:{ labels:Object.keys(clubMembers), datasets:[{label:'Members', data:Object.values(clubMembers), backgroundColor:generateColors(Object.keys(clubMembers).length)}] },
                options:{ responsive:true, scales:{y:{beginAtZero:true, ticks:{precision:0}}} }
            });

            // Events per Club
            new Chart(document.getElementById("clubEventChart"),{
                type:'bar',
                data:{ labels:Object.keys(clubEvents), datasets:[{label:'Events', data:Object.values(clubEvents), backgroundColor:generateColors(Object.keys(clubEvents).length)}] },
                options:{ responsive:true, scales:{y:{beginAtZero:true, ticks:{precision:0}}} }
            });

            // Announcements per Club
            new Chart(document.getElementById("clubAnnouncementChart"),{
                type:'bar',
                data:{ labels:Object.keys(clubAnnouncements), datasets:[{label:'Announcements', data:Object.values(clubAnnouncements), backgroundColor:generateColors(Object.keys(clubAnnouncements).length)}] },
                options:{ responsive:true, scales:{y:{beginAtZero:true, ticks:{precision:0}}} }
            });

        }catch(err){
            console.error("Error loading dashboard:",err);
            alert("Failed to load dashboard data. Check backend APIs.");
        }
    }

    document.addEventListener("DOMContentLoaded", loadDashboard);

    // Auto highlight active page
document.addEventListener("DOMContentLoaded", function () {
    const links = document.querySelectorAll(".sidebar a");
    const currentPage = window.location.pathname.split("/").pop();

    links.forEach(link => {
        if (link.getAttribute("href") === currentPage) {
            link.classList.add("active");
        }
    });
});

// Logout function
function logout() {
    // Clear login data
    localStorage.removeItem("loggedUser");
    sessionStorage.clear();

    // Redirect to login page
    window.location.href = "../login/login.html";
}

</script>

</body>
</html>
